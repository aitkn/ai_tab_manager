<!DOCTYPE html>
<!--
  AI Tab Manager - Copyright (c) 2025 AI Tech Knowledge LLC
  Proprietary License - See LICENSE file
  support@aitkn.com
-->
<html>
<head>
  <meta charset="utf-8">
  <title>AI Tab Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <div class="container">
    <div class="header-container">
      <h1>
        <img src="icon48.png" alt="AI Tab Manager" class="header-icon">
        AI Tab Manager
      </h1>
      <a href="https://buymeacoffee.com/aitkn" target="_blank" class="support-btn" title="Support Development">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M2,21H20V19H2M20,8H18V5H20M20,3H4V13A4,4 0 0,0 8,17H14A4,4 0 0,0 18,13V10H20A2,2 0 0,0 22,8V5C22,3.89 21.1,3 20,3Z" />
        </svg>
        <span>Support</span>
      </a>
    </div>
    
    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-btn" data-tab="categorize">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="7" height="7" rx="1"></rect>
          <rect x="14" y="3" width="7" height="7" rx="1"></rect>
          <rect x="14" y="14" width="7" height="7" rx="1"></rect>
          <rect x="3" y="14" width="7" height="7" rx="1"></rect>
        </svg>
        Current
        <span class="tab-badge" id="categorizeBadge" style="display: none;"></span>
      </button>
      <button class="tab-btn" data-tab="saved">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
        </svg>
        Saved
        <span class="tab-badge" id="savedBadge" style="display: none;"></span>
      </button>
      <button class="tab-btn" data-tab="settings">
        <svg viewBox="0 0 1024 1024" fill="currentColor">
          <path d="M600.704 64a32 32 0 0 1 30.464 22.208l35.2 109.376c14.784 7.232 28.928 15.36 42.432 24.512l112.384-24.192a32 32 0 0 1 34.432 15.36L944.32 364.8a32 32 0 0 1-4.032 37.504l-77.12 85.12a357.12 357.12 0 0 1 0 49.024l77.12 85.248a32 32 0 0 1 4.032 37.504l-88.704 153.6a32 32 0 0 1-34.432 15.296L708.8 803.904c-13.44 9.088-27.648 17.28-42.368 24.512l-35.264 109.376A32 32 0 0 1 600.704 960H423.296a32 32 0 0 1-30.464-22.208L357.696 828.48a351.616 351.616 0 0 1-42.56-24.64l-112.32 24.256a32 32 0 0 1-34.432-15.36L79.68 659.2a32 32 0 0 1 4.032-37.504l77.12-85.248a357.12 357.12 0 0 1 0-48.896l-77.12-85.248A32 32 0 0 1 79.68 364.8l88.704-153.6a32 32 0 0 1 34.432-15.296l112.32 24.256c13.568-9.152 27.776-17.408 42.56-24.64l35.2-109.312A32 32 0 0 1 423.232 64H600.64zm-23.424 64H446.72l-36.352 113.088-24.512 11.968a294.113 294.113 0 0 0-34.816 20.096l-22.656 15.36-116.224-25.088-65.28 113.152 79.68 88.192-1.92 27.136a293.12 293.12 0 0 0 0 40.192l1.92 27.136-79.808 88.192 65.344 113.152 116.224-25.024 22.656 15.296a294.113 294.113 0 0 0 34.816 20.096l24.512 11.968L446.72 896h130.688l36.48-113.152 24.448-11.904a288.282 288.282 0 0 0 34.752-20.096l22.592-15.296 116.288 25.024 65.28-113.152-79.744-88.192 1.92-27.136a293.12 293.12 0 0 0 0-40.256l-1.92-27.136 79.808-88.128-65.344-113.152-116.288 24.96-22.592-15.232a287.616 287.616 0 0 0-34.752-20.096l-24.448-11.904L577.344 128zM512 320a192 192 0 1 1 0 384 192 192 0 0 1 0-384zm0 64a128 128 0 1 0 0 256 128 128 0 0 0 0-256z"/>
        </svg>
        Settings
      </button>
    </div>
    
    <!-- Unified Toolbar -->
    <div id="unifiedToolbar" class="unified-toolbar">
      <!-- First Row -->
      <div class="toolbar-row first-row">
        <!-- Left: Categorize button (Current Tab) -->
        <div class="toolbar-section left-section">
          <div id="currentTabControls" class="tab-specific-controls">
            <button id="categorizeBtn2" class="primary-btn" title="Categorize & Save tabs">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                <rect x="3" y="14" width="7" height="7" rx="1"></rect>
              </svg>
              Categorize & Save
            </button>
          </div>
        </div>
        
        <!-- Middle: Group By controls -->
        <div class="toolbar-section middle-section">
          <div class="control-group grouping-group">
            <label>Group by:</label>
            <select id="unifiedGroupingSelect" class="grouping-select">
              <!-- Options will be populated dynamically based on active tab -->
            </select>
            <button id="toggleGroupsBtn" class="icon-btn" title="Collapse/Expand all groups">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Right: Show All/Export/Import (Saved Tab) and Close All button -->
        <div class="toolbar-section right-section">
          <div id="savedTabControls" class="tab-specific-controls" style="display: none;">
            <div class="control-group show-all-group">
              <label class="checkbox-label" title="Show tabs in 'Ignore' category">
                <input type="checkbox" id="showAllCheckbox">
                <span>Show Ignore</span>
              </label>
            </div>
            <div class="control-group export-import-group">
              <button id="exportBtn" class="icon-btn" title="Export saved tabs as CSV">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
              </button>
              <button id="importBtn" class="icon-btn" title="Import tabs from CSV">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
              </button>
            </div>
          </div>
          <button id="closeAllBtn2" class="close-all-btn" title="Close all tabs">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Second Row: Search -->
      <div class="toolbar-row second-row">
        <div class="toolbar-section search-section">
          <input type="text" id="unifiedSearchInput" class="search-input" placeholder="Search tabs...">
          <button id="clearUnifiedSearchBtn" class="clear-search-btn" title="Clear search">×</button>
        </div>
      </div>
    </div>
    
    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Current Tab -->
      <div id="categorizeTab" class="tab-pane">
        <div id="tabsContainer" class="tabs-container" style="display: none;">
          <!-- Content will be populated when viewing current tabs -->
          <div id="currentContent"></div>
        </div>
      </div>
      
      <!-- Saved Tab -->
      <div id="savedTab" class="tab-pane">
        <div id="savedTabsContainer" class="tabs-container">
          <!-- Content will be populated when viewing saved tabs -->
          <div id="savedContent"></div>
        </div>
      </div>
      
      <!-- Settings Tab -->
      <div id="settingsTab" class="tab-pane">
        <div class="settings-content">
          <div class="setting-group">
            <label>Theme:</label>
            <div class="theme-switcher">
              <button class="theme-btn" data-theme="system">System</button>
              <button class="theme-btn" data-theme="light">Light</button>
              <button class="theme-btn" data-theme="dark">Dark</button>
            </div>
          </div>
          
          <div class="setting-group" style="border: 1px solid var(--md-sys-color-outline-variant); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 16px; font-size: 14px; font-weight: 600;">AI-Powered Categorization</h3>
            
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
              <input type="checkbox" id="useLLMCheckbox" checked>
              <label for="useLLMCheckbox" style="margin: 0; cursor: pointer;">
                Enable AI categorization
                <span class="text-muted" style="font-size: 11px; display: block; margin-top: 4px;">
                  When disabled, only rule-based categorization will be used
                </span>
              </label>
            </div>
            
            <div id="llmSettingsContainer">
              <div style="margin-bottom: 12px;">
                <label for="providerSelect">LLM Provider:</label>
                <select id="providerSelect" class="setting-select">
                  <option value="Claude">Claude</option>
                  <option value="OpenAI">OpenAI</option>
                  <option value="Gemini">Gemini</option>
                  <option value="DeepSeek">DeepSeek</option>
                  <option value="Grok">Grok</option>
                </select>
              </div>
              
              <div style="margin-bottom: 12px;">
                <label for="apiKeyInput">
                  API Key:
                  <a id="apiKeyLink" href="#" target="_blank" class="api-key-link" title="Get API key">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                      <polyline points="15 3 21 3 21 9"></polyline>
                      <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                  </a>
                </label>
                <input type="password" id="apiKeyInput" class="setting-input" placeholder="Enter API key">
                <button id="saveApiKeyBtn" class="secondary-btn">Save Key</button>
              </div>
              
              <div style="margin-bottom: 12px;">
                <label for="modelSelect">Model:</label>
                <select id="modelSelect" class="setting-select">
                  <!-- Models will be populated dynamically -->
                </select>
              </div>
              
              <div>
                <label for="promptTextarea">
                  Custom Prompt:
                  <span id="promptStatus" class="text-muted" style="font-size: 11px; margin-left: 8px;"></span>
                </label>
                <textarea id="promptTextarea" class="setting-textarea" rows="10" placeholder="Leave empty to use default prompt"></textarea>
                <button id="resetPromptBtn" class="secondary-btn">Reset to Default</button>
              </div>
            </div>
          </div>
          
          <div class="setting-group">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding-top: 8px; margin-bottom: 2px;">
              <h3 style="margin: 0; font-size: 14px; font-weight: 600;">Rule-Based Categorization</h3>
              <button id="restoreDefaultRulesBtn" class="secondary-btn" style="font-size: 12px; padding: 4px 8px;">
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                  <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                  <path d="M21 3v5h-5"/>
                  <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                </svg>
                Restore Default Rules
              </button>
            </div>
            <p class="text-muted" style="font-size: 12px; margin: 0 0 12px 0;">
              Create rules to automatically categorize tabs. Rules are applied before AI categorization.<br>
              <strong>How it works:</strong> Each rule is checked independently. The first matching rule determines the category.<br>
              <strong>Unmatched tabs:</strong> Will be sent to AI for categorization (if enabled) or placed in "Useful" category.
            </p>
            
            <div id="rulesContainer" class="rules-container">
              <!-- Category: Important (First) -->
              <div class="rule-category-section" data-category="3">
                <div class="rule-category-header" data-collapsed="true">
                  <div class="rule-category-title">
                    <span class="collapse-arrow">▶</span>
                    <svg class="category-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <span>Important</span>
                  </div>
                  <button class="add-rule-btn" data-category="3" title="Add new rule">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                </div>
                <div class="rules-table-wrapper">
                  <table class="rules-table">
                    <thead>
                      <tr>
                        <th>URL Pattern</th>
                        <th>Regex</th>
                        <th>Title Pattern</th>
                        <th>Regex</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody class="rules-list" data-category="3">
                      <!-- Rules will be populated here -->
                    </tbody>
                  </table>
                  <div class="rules-empty-state" style="display: none;">No rules defined. Click + to add a rule.</div>
                </div>
              </div>
              
              <!-- Category: Useful (Second) -->
              <div class="rule-category-section" data-category="2">
                <div class="rule-category-header" data-collapsed="true">
                  <div class="rule-category-title">
                    <span class="collapse-arrow">▶</span>
                    <svg class="category-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>Useful</span>
                  </div>
                  <button class="add-rule-btn" data-category="2" title="Add new rule">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                </div>
                <div class="rules-table-wrapper">
                  <table class="rules-table">
                    <thead>
                      <tr>
                        <th>URL Pattern</th>
                        <th>Regex</th>
                        <th>Title Pattern</th>
                        <th>Regex</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody class="rules-list" data-category="2">
                      <!-- Rules will be populated here -->
                    </tbody>
                  </table>
                  <div class="rules-empty-state" style="display: none;">No rules defined. Click + to add a rule.</div>
                </div>
              </div>
              
              <!-- Category: Ignore (Third) -->
              <div class="rule-category-section" data-category="1">
                <div class="rule-category-header" data-collapsed="true">
                  <div class="rule-category-title">
                    <span class="collapse-arrow">▶</span>
                    <svg class="category-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="15" y1="9" x2="9" y2="15"></line>
                      <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <span>Ignore</span>
                  </div>
                  <button class="add-rule-btn" data-category="1" title="Add new rule">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                </div>
                <div class="rules-table-wrapper">
                  <table class="rules-table">
                    <thead>
                      <tr>
                        <th>URL Pattern</th>
                        <th>Regex</th>
                        <th>Title Pattern</th>
                        <th>Regex</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody class="rules-list" data-category="1">
                      <!-- Rules will be populated here -->
                    </tbody>
                  </table>
                  <div class="rules-empty-state" style="display: none;">No rules defined. Click + to add a rule.</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="setting-group" style="border: 1px solid var(--md-sys-color-outline-variant); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 16px; font-size: 14px; font-weight: 600;">Machine Learning (Experimental)</h3>
            
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
              <input type="checkbox" id="useMLCheckbox" checked>
              <label for="useMLCheckbox" style="margin: 0; cursor: pointer;">
                Enable ML categorization
                <span class="text-muted" style="font-size: 11px; display: block; margin-top: 4px;">
                  Learns from your categorization patterns over time
                </span>
              </label>
            </div>
            
            <div id="mlDashboard">
              <!-- ML Status -->
              <div class="ml-status-card" style="background: var(--md-sys-color-surface-container); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 500;">Model Status</h4>
                <div id="mlStatusContent" style="font-size: 12px;">
                  <div class="ml-status-loading" style="color: var(--md-sys-color-on-surface-variant);">Loading ML status...</div>
                </div>
              </div>
              
              <!-- Trust Weights -->
              <div class="ml-trust-card" style="background: var(--md-sys-color-surface-container); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 500;">Method Trust Weights</h4>
                <div id="mlTrustContent" style="font-size: 12px;">
                  <div class="ml-trust-loading">Loading trust data...</div>
                </div>
              </div>
              
              <!-- Performance Metrics -->
              <div class="ml-performance-card" style="background: var(--md-sys-color-surface-container); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 500;">Performance Metrics</h4>
                <div id="mlPerformanceContent" style="font-size: 12px;">
                  <div class="ml-performance-loading">Loading performance data...</div>
                </div>
              </div>
              
              <!-- Training Settings -->
              <div class="ml-settings-card" style="background: var(--md-sys-color-surface-container); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 500;">Training Settings</h4>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <label for="mlEpochsInput" style="font-size: 12px; min-width: 80px;">Epochs:</label>
                  <input type="number" id="mlEpochsInput" min="1" max="100" value="10" 
                         style="width: 60px; padding: 4px 6px; border: 1px solid var(--md-sys-color-outline-variant); border-radius: 4px; font-size: 12px;">
                  <span class="text-muted" style="font-size: 11px;">Training iterations (1-100)</span>
                </div>
              </div>
              
              <!-- Training Controls -->
              <div class="ml-training-card" style="background: var(--md-sys-color-surface-container); padding: 12px; border-radius: 8px;">
                <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 500;">Training Controls</h4>
                <div id="mlTrainingContent" style="font-size: 12px;">
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <button id="trainModelBtn" class="secondary-btn" style="font-size: 12px; padding: 4px 12px;">Train Now</button>
                    <button id="resetModelBtn" class="secondary-btn" style="font-size: 12px; padding: 4px 12px; color: var(--md-sys-color-error);">Reset Model</button>
                    <span id="trainingStatus" class="text-muted" style="font-size: 11px;"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="setting-group">
            <label for="maxTabsInput">
              Max Tabs to Open at Once:
              <span class="text-muted" style="font-size: 11px; margin-left: 8px;">(Safety limit)</span>
            </label>
            <input type="number" id="maxTabsInput" class="setting-input" min="1" max="200" placeholder="50">
            <span class="text-muted" style="font-size: 11px; display: block; margin-top: 4px;">
              Default: 50 tabs. Set higher at your own risk.
            </span>
          </div>
          
          <div class="setting-group" style="text-align: center; margin-top: 20px;">
            <p class="text-muted" style="font-size: 11px;">
              © 2025 AI Tech Knowledge LLC<br>
              <a href="https://github.com/aitkn/ai_tab_manager" target="_blank" style="color: var(--text-muted);">GitHub</a> • 
              <a href="https://buymeacoffee.com/aitkn" target="_blank" style="color: var(--text-muted);">Support Development</a>
            </p>
          </div>
        </div>
      </div>
    </div>
    
    <div id="apiKeyPrompt" class="api-key-prompt" style="display: none;">
      <p>Please configure your LLM settings first.</p>
      <button id="openSettingsBtn" class="primary-btn">Open Settings</button>
    </div>
    
    <!-- Status bar at bottom -->
    <div id="status" class="status"></div>
  </div>
  
  <!-- Hidden file input for CSV import -->
  <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
  
  <script src="config.js"></script>
  <script src="database.js"></script>
  <script src="src/libs/morphdom.min.js"></script>
  <script type="module" src="popup.js"></script>
</body>
</html>